name: ğŸš€ CI/CD Pipeline - HR SaaS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  SKIP_ENV_VALIDATION: 'true'

jobs:
  # ======================================
  # ğŸ§ª TESTING & LINTING
  # ======================================
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ—ï¸ Type check
        run: npx tsc --noEmit

      - name: ğŸ§ª Run tests
        run: npm test
        continue-on-error: true

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level moderate
        continue-on-error: true

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        if: success()
        continue-on-error: true

  # ======================================
  # ğŸ—ï¸ BUILD VERIFICATION
  # ======================================
  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://fwyxmovfrzauebiqxchz.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'sb_publishable_K5XwWr0RPK7mq2L2z0TZfA_u6ZreOF7' }}

      - name: ğŸ“¦ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-

  # ======================================
  # ğŸš¢ STAGING DEPLOYMENT
  # ======================================
  deploy-staging:
    name: ğŸš¢ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Railway (Staging)
        run: |
          echo "ğŸš¢ Deploying to Railway staging environment..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
        # Railway CLI deployment would go here
        # Actual deployment handled by Railway's GitHub integration

      - name: ğŸ§ª Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          # Add health check logic here
          
      - name: ğŸ“¢ Notify deployment
        if: success()
        run: |
          echo "âœ… Staging deployment successful!"
          echo "URL: https://staging-hr-saas.railway.app"

  # ======================================
  # ğŸŒŸ PRODUCTION DEPLOYMENT  
  # ======================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Security check
        run: |
          echo "ğŸ”’ Running security checks..."
          npm audit --audit-level high

      - name: ğŸš€ Deploy to Railway (Production)
        run: |
          echo "ğŸŒŸ Deploying to Railway production environment..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
        # Railway CLI deployment would go here

      - name: ğŸ§ª Production health check
        run: |
          echo "ğŸ¥ Performing production health check..."
          # Add comprehensive health check

      - name: ğŸ“Š Performance monitoring
        run: |
          echo "ğŸ“Š Setting up monitoring..."
          # Add monitoring setup

      - name: ğŸ“¢ Notify deployment
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "URL: https://hr-saas.railway.app"

  # ======================================
  # ğŸ—„ï¸ DATABASE MIGRATIONS
  # ======================================
  migrate-database:
    name: ğŸ—„ï¸ Database Migrations
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ—„ï¸ Run Supabase migrations
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"
          # Supabase migration commands would go here
          # npx supabase db push

      - name: âœ… Verify migrations
        run: |
          echo "âœ… Verifying database schema..."
          # Add migration verification logic

  # ======================================
  # ğŸ”„ POST-DEPLOYMENT TASKS
  # ======================================
  post-deployment:
    name: ğŸ”„ Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
      - name: ğŸ§¹ Cache cleanup
        run: |
          echo "ğŸ§¹ Cleaning up build caches..."

      - name: ğŸ“Š Update metrics
        run: |
          echo "ğŸ“Š Updating deployment metrics..."

      - name: ğŸ‰ Success notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment pipeline completed successfully!"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
